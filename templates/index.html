<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trustap Vehicle Reservations Demo</title>
    <link rel="stylesheet" href="/assets/bootstrap-5.3.8-dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/custom.css">
</head>
<body>

    <header>
        <div class="container d-flex justify-content-between align-items-center">
            <a href="/"><img src="/assets/logo.png" alt="Logo" style="height: 40px;"></a>
            <div class="d-none d-md-flex gap-4">
                <a href="#" class="text-dark text-decoration-none fw-bold">New</a>
                <a href="#" class="text-dark text-decoration-none fw-bold">Used</a>
                <a href="#" class="text-dark text-decoration-none fw-bold">In-Transit</a>
            </div>
            <div class="header-phone text-end">
                Trustap Vehicle <br class="d-md-none"> Reservations
            </div>
        </div>
    </header>

    <div class="container pb-5">
        <h1 class="h3 mb-4 fw-light">Search Inventory <span class="fs-6 text-muted">({{ vehicles|length }} Vehicles Found)</span></h1>

        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
            {% for car in vehicles %}
            <div class="col">
                <div class="vehicle-card">
                    <a href="/items/item_{{ car.id }}.html" class="card-img-wrapper">
                        <img src="/items/{{ car.folder }}/hero.png" alt="{{ car.title }}">
                    </a>
                    <div class="card-body p-3 d-flex flex-column flex-grow-1">
                        <a href="/items/item_{{ car.id }}.html" class="vehicle-title">{{ car.title }}</a>
                        <div class="text-muted small mb-3">
                            <div>VIN: {{ car.vin }}</div>
                            <div>Stock: {{ car.stock }}</div>
                        </div>
                        <div class="mt-auto">
                            <div class="vehicle-price mb-3">{{ car.price }}</div>
                            <a href="/items/item_{{ car.id }}.html" class="btn-primary-brand">Check Availability</a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div id="missionModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeMission()">&times;</span>
            <div class="mission-icon">üïµÔ∏è</div>
            <h2 class="mission-title">Welcome to the Trustap NADA Demo</h2>
            <p class="mission-body">
                Feel free to explore the inventory. We have hidden a special 
                <strong>"Golden Car"</strong> with a unique reward.
                <br><br>
                Try to find it and complete the reservation process to see the 
                Trustap integration in action.
            </p>
            <button onclick="closeMission()" class="btn-primary-brand">Start Browsing</button>
        </div>
    </div>

    <footer class="site-footer">
        <div class="container"> 
            <div class="footer-text">Trustap Ltd 2026</div>
            <div class="footer-subtext">‚òòÔ∏è Born in Ireland, Trusted Worldwide üåç</div>
        </div>
    </footer>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const modal = document.getElementById('missionModal');
        
        // 1. Get Navigation Type
        const navigationEntries = performance.getEntriesByType("navigation");
        const navType = navigationEntries.length > 0 ? navigationEntries[0].type : '';

        // 2. Check Referrer (Where did we come from?)
        // If the referrer URL contains our own domain (pythonanywhere.com), it's an internal click.
        // If the referrer is the parent page (trustap.com) or empty, it's a fresh entry.
        const referrer = document.referrer;
        const currentDomain = window.location.hostname; // e.g., "dcr5000.pythonanywhere.com"
        const isInternalNav = referrer.includes(currentDomain);

        console.log("Nav Type:", navType);
        console.log("Referrer:", referrer);
        console.log("Internal?", isInternalNav);

        // --- THE LOGIC ---
        
        // CASE A: Back Button (ALWAYS HIDE)
        if (navType === 'back_forward') {
            console.log("Back button used. Keeping modal hidden.");
            // Do nothing (modal is hidden by default in CSS)
        }
        
        // CASE B: Refresh OR Fresh Entry from Outside (SHOW)
        // If we reloaded explicitly OR we navigated here from a different domain (like the parent iframe refresh)
        else if (navType === 'reload' || (navType === 'navigate' && !isInternalNav)) {
            console.log("Fresh Start detected. Showing Mission.");
            modal.style.display = 'flex';
            
            // We can clear the 'seen' flag if you want the "Golden Car" to reset too
            sessionStorage.removeItem('missionSeen'); 
        }
        
        // CASE C: Internal Navigation (Home Button / Logo) (HIDE)
        else {
            console.log("Internal navigation detected. Keeping modal hidden.");
        }
    });

    function closeMission() {
        document.getElementById('missionModal').style.display = 'none';
        // Optional: Set a flag if you need it for other logic later
        sessionStorage.setItem('missionSeen', 'true');
    }
</script>
</body>
</html>