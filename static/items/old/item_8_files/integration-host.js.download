"use strict";(()=>{var O=["lectrium","localhost"];function se(e){let t=e.src||"";return O.some(n=>t.includes(n))}function _(){return Array.from(document.getElementsByTagName("iframe")).filter(r=>se(r))}function K(e){return Array.from(e).some(t=>t instanceof HTMLIFrameElement||t.nodeName==="IFRAME"?!0:t instanceof Element?t.getElementsByTagName("iframe").length>0:!1)}function z(e){let t=new MutationObserver(n=>{let o=!1;for(let s of n){if(s.type!=="childList")continue;if(K(s.addedNodes)||K(s.removedNodes)){o=!0;break}}o&&e()}),r={childList:!0,subtree:!0};return t.observe(document.documentElement,r),t}var u;(function(e){e.Call="call",e.Reply="reply",e.Syn="syn",e.SynAck="synAck",e.Ack="ack"})(u||(u={}));var I;(function(e){e.Fulfilled="fulfilled",e.Rejected="rejected"})(I||(I={}));var C;(function(e){e.ConnectionDestroyed="ConnectionDestroyed",e.ConnectionTimeout="ConnectionTimeout",e.NoIframeSrc="NoIframeSrc"})(C||(C={}));var x;(function(e){e.DataCloneError="DataCloneError"})(x||(x={}));var w;(function(e){e.Message="message"})(w||(w={}));var N=(e,t)=>{let r=[],n=!1;return{destroy(o){n||(n=!0,t(`${e}: Destroying connection`),r.forEach(s=>{s(o)}))},onDestroy(o){n?o():r.push(o)}}};var k=e=>(...t)=>{e&&console.log("[Penpal]",...t)};var ie={"http:":"80","https:":"443"},ae=/^(https?:)?\/\/([^/:]+)?(:(\d+))?/,ce=["file:","data:"],U=e=>{if(e&&ce.find(i=>e.startsWith(i)))return"null";let t=document.location,r=ae.exec(e),n,o,s;r?(n=r[1]?r[1]:t.protocol,o=r[2],s=r[4]):(n=t.protocol,o=t.hostname,s=t.port);let a=s&&s!==ie[n]?`:${s}`:"";return`${n}//${o}${a}`};var P=({name:e,message:t,stack:r})=>({name:e,message:t,stack:r}),Y=e=>{let t=new Error;return Object.keys(e).forEach(r=>t[r]=e[r]),t};var F=(e,t,r)=>{let{localName:n,local:o,remote:s,originForSending:a,originForReceiving:i}=e,h=!1,m=d=>{if(d.source!==s||d.data.penpal!==u.Call)return;if(i!=="*"&&d.origin!==i){r(`${n} received message from origin ${d.origin} which did not match expected origin ${i}`);return}let l=d.data,{methodName:p,args:g,id:E}=l;r(`${n}: Received ${p}() call`);let y=c=>v=>{if(r(`${n}: Sending ${p}() reply`),h){r(`${n}: Unable to send ${p}() reply due to destroyed connection`);return}let M={penpal:u.Reply,id:E,resolution:c,returnValue:v};c===I.Rejected&&v instanceof Error&&(M.returnValue=P(v),M.returnValueIsError=!0);try{s.postMessage(M,a)}catch(f){if(f.name===x.DataCloneError){let R={penpal:u.Reply,id:E,resolution:I.Rejected,returnValue:P(f),returnValueIsError:!0};s.postMessage(R,a)}throw f}};new Promise(c=>c(t[p].apply(t,g))).then(y(I.Fulfilled),y(I.Rejected))};return o.addEventListener(w.Message,m),()=>{h=!0,o.removeEventListener(w.Message,m)}};var de=0,W=()=>++de;var V=e=>e?e.split("."):[],le=e=>e.join("."),me=(e,t)=>{let r=V(t||"");return r.push(e),le(r)},fe=(e,t,r)=>{let n=V(t);return n.reduce((o,s,a)=>(typeof o[s]>"u"&&(o[s]={}),a===n.length-1&&(o[s]=r),o[s]),e),e},L=(e,t)=>{let r={};return Object.keys(e).forEach(n=>{let o=e[n],s=me(n,t);typeof o=="object"&&Object.assign(r,L(o,s)),typeof o=="function"&&(r[s]=o)}),r},j=e=>{let t={};for(let r in e)fe(t,r,e[r]);return t};var b=(e,t,r,n,o)=>{let{localName:s,local:a,remote:i,originForSending:h,originForReceiving:m}=t,d=!1;o(`${s}: Connecting call sender`);let l=g=>(...E)=>{o(`${s}: Sending ${g}() call`);let y;try{i.closed&&(y=!0)}catch{y=!0}if(y&&n(),d){let c=new Error(`Unable to send ${g}() call due to destroyed connection`);throw c.code=C.ConnectionDestroyed,c}return new Promise((c,v)=>{let M=W(),f=T=>{if(T.source!==i||T.data.penpal!==u.Reply||T.data.id!==M)return;if(m!=="*"&&T.origin!==m){o(`${s} received message from origin ${T.origin} which did not match expected origin ${m}`);return}let A=T.data;o(`${s}: Received ${g}() reply`),a.removeEventListener(w.Message,f);let H=A.returnValue;A.returnValueIsError&&(H=Y(H)),(A.resolution===I.Fulfilled?c:v)(H)};a.addEventListener(w.Message,f);let R={penpal:u.Call,id:M,methodName:g,args:E};i.postMessage(R,h)})},p=r.reduce((g,E)=>(g[E]=l(E),g),{});return Object.assign(e,j(p)),()=>{d=!0}};var G=(e,t,r,n,o)=>{let{destroy:s,onDestroy:a}=n,i,h,m={};return d=>{if(t!=="*"&&d.origin!==t){o(`Parent: Handshake - Received ACK message from origin ${d.origin} which did not match expected origin ${t}`);return}o("Parent: Handshake - Received ACK");let l={localName:"Parent",local:window,remote:d.source,originForSending:r,originForReceiving:t};i&&i(),i=F(l,e,o),a(i),h&&h.forEach(g=>{delete m[g]}),h=d.data.methodNames;let p=b(m,l,h,s,o);return a(p),m}};var B=(e,t,r,n)=>o=>{if(!o.source)return;if(r!=="*"&&o.origin!==r){e(`Parent: Handshake - Received SYN message from origin ${o.origin} which did not match expected origin ${r}`);return}e("Parent: Handshake - Received SYN, responding with SYN-ACK");let s={penpal:u.SynAck,methodNames:Object.keys(t)};o.source.postMessage(s,n)};var q=(e,t)=>{let{destroy:r,onDestroy:n}=t,o=setInterval(()=>{e.isConnected||(clearInterval(o),r())},6e4);n(()=>{clearInterval(o)})};var $=(e,t)=>{let r;return e!==void 0&&(r=window.setTimeout(()=>{let n=new Error(`Connection timed out after ${e}ms`);n.code=C.ConnectionTimeout,t(n)},e)),()=>{clearTimeout(r)}};var J=e=>{if(!e.src&&!e.srcdoc){let t=new Error("Iframe must have src or srcdoc property defined.");throw t.code=C.NoIframeSrc,t}};var D=e=>{let{iframe:t,methods:r={},childOrigin:n,timeout:o,debug:s=!1}=e,a=k(s),i=N("Parent",a),{onDestroy:h,destroy:m}=i;n||(J(t),n=U(t.src));let d=n==="null"?"*":n,l=L(r),p=B(a,l,n,d),g=G(l,n,d,i,a);return{promise:new Promise((y,c)=>{let v=$(o,m),M=f=>{if(!(f.source!==t.contentWindow||!f.data)){if(f.data.penpal===u.Syn){p(f);return}if(f.data.penpal===u.Ack){let R=g(f);R&&(v(),y(R));return}}};window.addEventListener(w.Message,M),a("Parent: Awaiting handshake"),q(t,i),h(f=>{window.removeEventListener(w.Message,M),f&&c(f)})}),destroy(){m()}}};function Q(e){try{return JSON.parse(JSON.stringify(e))}catch{}}function X(e){if(!e)return e;let t=Q(e);if(t)return t;let r=Object.entries(e||{}).map(([n,o])=>[n,Q(o)]);return Object.fromEntries(r)}var ue=e=>new Promise(t=>setTimeout(t,e));function Z(e){let t=!1;return{ping:()=>"pong",getHostUrl:()=>window?.location?.href,resize:l=>{t||(e.style.height=`${l}px`,e.style.minHeight=`${l}px`)},disable:()=>{t=!0,e.style.display="none"},enable:()=>{t=!1,e.style.display==="none"&&(e.style.display="")},forwardGTMEvent:l=>{let p=window.dataLayer;if(p)try{p.push(l)}catch{}},queryAscDataLayer:async()=>{try{let E=()=>{let y=window,c=y.asc_dataLayer||y.asc_datalayer;return c?X(c):null};for(let y=0;y<100;y++){let c=E();if(c)return c;await ue(50)}}catch{return}},delete:()=>{},showModal:l=>{t||console.log("showModal not implemented yet:",l)}}}var ee="lectrium-host-ready",pe="lectrium-is-host-ready";function te(e){let t=r=>{r.source!==e.contentWindow||r.data?.type!==pe||!e.contentWindow||e.contentWindow.postMessage({type:ee},"*")};return window.addEventListener("message",t),()=>{window.removeEventListener("message",t)}}function re(e){e.contentWindow?.postMessage({type:ee},"*")}function ge(){try{return localStorage.getItem("lectrium-debug")==="true"}catch{return!1}}var S=class{constructor(){this._iframes=new Map;this._url=window.location.href}async setIframes(t){let r=new Set(this._iframes.keys()),n=new Set(t);for(let s of r)n.has(s)||this.removeIframe(s);let o=[];for(let s of n)r.has(s)||o.push(this.addIframe(s));await Promise.all(o)}async addIframe(t){if(!t.contentWindow){console.warn("[Lectrium] Iframe has no contentWindow, skipping integration",t);return}let n=Z(t),o=ge(),s=D({iframe:t,methods:n,debug:o}),a=te(t);re(t);let i=await s.promise;if(await i.who()!=="lectrium-dashboard-hub"){console.warn("[Lectrium] mismatching iframe contract, skipping",t),s.destroy();return}let m={element:t,connection:s,hostMethods:n,client:i,readyCheckListenerCleanup:a};this._iframes.set(t,m),i.updateUrl(this._url)}setUrl(t){this._url=t;for(let r of this.getClients())r.updateUrl(t)}removeIframe(t){let r=this._iframes.get(t);r?.connection&&r.connection.destroy(),r?.readyCheckListenerCleanup(),this._iframes.delete(t)}getClients(){return Array.from(this._iframes.values()).map(t=>t.client)}getClient(t){return this._iframes.get(t)?.client}};var oe="__LECTRIUM_HUB_MANAGER__";function ne(){if(typeof window>"u"||window[oe])return;let e=new S;window[oe]=e,e.setIframes(_()),z(()=>{e.setIframes(_())})}ne();})();
//# sourceMappingURL=integration-host.js.map
